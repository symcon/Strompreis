<?php

declare(strict_types=1);

class PowerPrice extends IPSModule
{
    public function Create()
    {
        $this->RegisterPropertyString('Provider', 'aWATTar');
        $this->RegisterPropertyString('EPEXSpotMarket', 'DE-LU');
        $this->RegisterPropertyString('aWATTarMarket', 'de');
        $this->RegisterPropertyString('TibberPostalCode', '23554');
        $this->RegisterPropertyFloat('PriceBase', 19.5);
        $this->RegisterPropertyFloat('PriceSurcharge', 3);
        $this->RegisterPropertyFloat('PriceTax', 19);

        if (!IPS_VariableProfileExists('Cent')) {
            IPS_CreateVariableProfile('Cent', 2);
            IPS_SetVariableProfileDigits('Cent', 2);
            IPS_SetVariableProfileText('Cent', '', ' ct');
        }

        $this->RegisterVariableString('MarketData', $this->Translate('Market Data'), '~TextBox', 0);
        $this->RegisterVariableFloat('CurrentPrice', $this->Translate('Current Price'), 'Cent', 1);

        $this->SetVisualizationType(1);

        // Load initially after 30 seconds
        $this->RegisterTimer('Update', 30000, 'SPX_Update($_IPS["TARGET"]);');
    }

    public function GetConfigurationForm()
    {
        $form = json_decode(file_get_contents(__DIR__ . '/form.json'), true);
        $form['elements'][1]['visible'] = $this->ReadPropertyString('Provider') === 'aWATTar';
        $form['elements'][2]['visible'] = $this->ReadPropertyString('Provider') === 'Tibber';
        $form['elements'][3]['visible'] = $this->ReadPropertyString('Provider') === 'EPEXSpot';

        // Tibber includes full price information
        $form['elements'][4]['visible'] = $this->ReadPropertyString('Provider') != 'Tibber';
        $form['elements'][5]['visible'] = $this->ReadPropertyString('Provider') != 'Tibber';
        $form['elements'][6]['visible'] = $this->ReadPropertyString('Provider') != 'Tibber';
        $form['elements'][7]['visible'] = $this->ReadPropertyString('Provider') != 'Tibber';
        $form['elements'][8]['visible'] = $this->ReadPropertyString('Provider') != 'Tibber';
        return json_encode($form);
    }

    public function Update()
    {
        $marketData = '[]';
        switch ($this->ReadPropertyString('Provider')) {
            case 'aWATTar':
                $marketData = $this->FetchFromAwattar($this->ReadPropertyString('aWATTarMarket'));
                break;
            case 'Tibber':
                $marketData = $this->FetchFromTibber($this->ReadPropertyString('TibberPostalCode'));
                break;
            case 'EPEXSpot':
                $marketData = $this->FetchFromEPEXSpot($this->ReadPropertyString('EPEXSpotMarket'));
                break;
        }
        $this->UpdateVisualizationValue($marketData);
        $this->SetValue('MarketData', $marketData);

        $currentTime = time();
        $found = false;
        foreach (json_decode($marketData) as $row) {
            if ($currentTime >= $row->start && $currentTime <= $row->end) {
                $this->SetValue('CurrentPrice', $row->price);
                $found = true;
                break;
            }
        }
        if (!$found) {
            $this->SetValue('CurrentPrice', 999.99);
        }

        // Synchronize to xx:00:30
        $waitTime = (3600 * 1000) - ((microtime(true) * 1000) % (3600 * 1000)) + (30 * 1000);
        $this->SetTimerInterval('Update', $waitTime);
    }

    public function GetVisualizationTile()
    {
        // Add static HTML content from file to make editing easier
        $module = file_get_contents(__DIR__ . '/module.html');

        // Inject current values
        $module = str_replace('%market_data%', $this->GetValue('MarketData'), $module);

        // Return everything to render our fancy tile!
        return $module;
    }

    public function UIChangeProvider(string $Provider)
    {
        $this->UpdateFormField('aWATTarMarket', 'visible', $Provider === 'aWATTar');
        $this->UpdateFormField('TibberPostalCode', 'visible', $Provider === 'Tibber');
        $this->UpdateFormField('EPEXSpotMarket', 'visible', $Provider === 'EPEXSpot');

        $this->UpdateFormField('PriceHint', 'visible', $Provider != 'Tibber');
        $this->UpdateFormField('PriceBase', 'visible', $Provider != 'Tibber');
        $this->UpdateFormField('PricePremiumHint', 'visible', $Provider != 'Tibber');
        $this->UpdateFormField('PriceSurcharge', 'visible', $Provider != 'Tibber');
        $this->UpdateFormField('PriceTax', 'visible', $Provider != 'Tibber');
    }

    private function NormalizeAndReduce($data)
    {
        $result = [];

        $base = $this->ReadPropertyFloat('PriceBase');
        $surcharge = (100 + $this->ReadPropertyFloat('PriceSurcharge')) / 100;

        /*
         * We want to normalize data to this format:
         *
         * {
         *  "start" : <Unix-Timestamp>
         *  "end"   : <Unix-Timestamp>
         *  "price" : <Final price in cent per kwH>
         * }
         *
         */
        if (count($data) > 24) {
            for ($i = 0; $i < 48; $i++) {
                if (count($data)) {
                    if (time() > ($data[0]['end_timestamp'] / 1000)) {
                        array_shift($data);
                    }
                }
            }
        }
        foreach ($data as $row) {
            $value = [
                'start' => $row['start_timestamp'] / 1000,
                'end'   => $row['end_timestamp'] / 1000,
            ];
            switch ($row['unit']) {
                case 'Eur/MWh':
                    $value['price'] = $base + ((($row['marketprice'] * (1 + ($this->ReadPropertyFloat('PriceTax') / 100))) / 10) * $surcharge);
                    break;
                default:
                    $value['price'] = 0;
                    break;
            }
            $result[] = $value;
        }

        return json_encode($result);
    }

    private function FetchFromEPEXSpotEx($market, $trading_date, $delivery_date)
    {
        $params = [
            'market_area'   => $market,
            'trading_date'  => $trading_date,
            'delivery_date' => $delivery_date,
            'modality'      => 'Auction',
            'sub_modality'  => 'DayAhead',
            'product'       => '60',
            'data_mode'     => 'table',
            'ajax_form'     => '1',
        ];

        $opts = [
            'http' => [
                'method'  => 'POST',
                'header'  => 'Content-Type: application/x-www-form-urlencoded',
                'content' => http_build_query([
                    'form_id'                  => 'market_data_filters_form',
                    '_triggering_element_name' => 'submit_js',
                ]),
            ],
        ];

        $response = file_get_contents('https://www.epexspot.com/en/market-results?' . http_build_query($params), false, stream_context_create($opts));

        $json = json_decode($response);

        // HTML extrahieren
        foreach ($json as $key => $value) {
            if ($value->command == 'invoke' && $value->method == 'html' && $value->selector == '.js-md-widget') {
                $invoke = $value;
            }
        }

        // Als HTML DOM laden
        $doc = new DOMDocument();
        @$doc->loadHTML($invoke->args[0]); // Das @-Zeichen unterdrÃ¼ckt Warnungen wegen fehlerhaftem HTML
        $xpath = new DOMXPath($doc);

        $table = [];

        // Extrahieren der Stunden
        $hours = $xpath->query('//div[contains(@class, "js-table-times")]//li/a');
        foreach ($hours as $i => $hour) {
            $table[$i] = [$hour->nodeValue];
        }

        // Extrahieren der Preis- und Volumendaten
        $rows = $xpath->query('//div[contains(@class, "js-table-values")]//tr[contains(@class, "child")]');

        $i = 0;
        foreach ($rows as $row) {
            $cells = $row->childNodes;
            $rowData = [];
            $j = 1;
            foreach ($cells as $cell) {
                if ($cell instanceof DOMElement) {
                    $table[$i][$j] = $cell->nodeValue;
                    $j++;
                }
            }
            $i++;
        }

        // Daten zu unserem Zielformat konvertieren
        $result = [];
        foreach ($table as $row) {

            $date = DateTime::createFromFormat('Y-m-d', $delivery_date);
            list($startHour, $endHour) = explode(' - ', $row[0]);
            $startTime = clone $date;
            $startTime->setTime((int) $startHour, 0); // Stunden und Minuten setzen
            $endTime = clone $date;
            $endTime->setTime((int) $endHour, 0); // Stunden und Minuten setzen

            $result[] = [
                'start_timestamp' => $startTime->getTimestamp() * 1000,
                'end_timestamp'   => $endTime->getTimestamp() * 1000,
                'marketprice'     => floatval($row[4]),
                'unit'            => 'Eur/MWh'
            ];
        }
        return $result;
    }

    private function FetchFromEPEXSpot($market)
    {
        $data = [];
        $data = array_merge($data, $this->FetchFromEpexSpotEx($market, date('Y-m-d', strtotime('-1 day')), date('Y-m-d')));
        if (date('H') >= 14) {
            $data = array_merge($data, $this->FetchFromEpexSpotEx($market, date('Y-m-d'), date('Y-m-d', strtotime('+1 day'))));
        }
        return $this->NormalizeAndReduce($data);
    }

    private function FetchFromAwattar($market)
    {
        $start = mktime(0, 0, 0, intval(date('m')), intval(date('d')), intval(date('Y')));
        $end = mktime(0, 0, 0, intval(date('m')), intval(date('d') + 1), intval(date('Y')));
        $data = file_get_contents(sprintf('https://api.awattar.%s/v1/marketdata?start=%s&end=%s', $market, $start * 1000, $end * 1000));
        return $this->NormalizeAndReduce(json_decode($data, true)['data']);
    }

    private function FetchFromTibber($postalCode)
    {
        $data = file_get_contents(sprintf('https://tibber.com/de/api/lookup/price-overview?postalCode=%s', $postalCode));
        $energy = json_decode($data, true)['energy']['todayHours'];
        $result = [];
        foreach ($energy as $hour) {
            $date = explode('-', $hour['date']);
            $result[] = [
                'start' => mktime($hour['hour'], 0, 0, intval($date[1]), intval($date[2]), intval($date[0])),
                'end'   => mktime($hour['hour'] + 1, 0, 0, intval($date[1]), intval($date[2]), intval($date[0])),
                'price' => $hour['priceIncludingVat'] * 100,
            ];
        }
        return json_encode($result);
    }
}
